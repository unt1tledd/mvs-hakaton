<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MWS Analytics</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background: #0f172a; color: white; min-height: 100vh; }
    .screen { display: none; }
    .screen.active { display: flex; }
    .card { background: rgba(255,255,255,0.06); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); border-radius: 28px; padding: 48px; max-width: 560px; width: 100%; }
    .btn { background: #ef4444; color: white; font-weight: 800; font-size: 18px; padding: 18px 40px; border-radius: 20px; border: none; cursor: pointer; transition: all 0.3s; box-shadow: 0 10px 30px rgba(239,68,68,0.4); }
    .btn:hover { transform: translateY(-6px); box-shadow: 0 20px 40px rgba(239,68,68,0.5); }
    input { background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); color: white; padding: 16px 20px; border-radius: 16px; width: 100%; font-size: 16px; margin-bottom: 16px; }
    input::placeholder { color: rgba(255,255,255,0.6); }
    input:focus { outline: none; border-color: #ef4444; }
    .toast { position: fixed; bottom: 30px; right: 30px; background: #1e293b; color: white; padding: 16px 32px; border-radius: 16px; opacity: 0; transition: opacity 0.4s; z-index: 1000; }
    .toast.show { opacity: 1; }
    .dropdown { position: absolute; top: 100%; left: 50%; transform: translateX(-50%); margin-top: 12px; background: #1e293b; border-radius: 20px; width: 280px; box-shadow: 0 20px 60px rgba(0,0,0,0.6); opacity: 0; visibility: hidden; transition: all 0.3s; pointer-events: none; z-index: 100; }
    .dropdown.show { opacity: 1; visibility: visible; pointer-events: auto; }
    .dropdown a { display: block; padding: 16px 20px; transition: 0.2s; }
    .dropdown a:hover { background: rgba(239,68,68,0.3); }

    /* Вертикальная аналитика — красиво и не едет */
    .stats-grid { display: flex; flex-direction: column; gap: 24px; max-width: 480px; margin: 0 auto; }
    .stat-block { background: rgba(255,255,255,0.08); border-radius: 24px; padding: 32px 24px; text-align: center; transition: transform 0.3s; }
    .stat-block:hover { transform: translateY(-8px); }
    .stat-value { font-size: 4.5rem; font-weight: 900; color: #ef4444; line-height: 1; }
    .stat-label { font-size: 1.2rem; opacity: 0.8; margin-top: 8px; }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen p-6">

  <!-- 0. Приветствие -->
  <div id="step0" class="screen active flex-col items-center justify-center">
    <div class="card text-center">
      <h1 class="text-6xl font-black mb-6">MWS Analytics</h1>
      <p class="text-2xl opacity-80 mb-12">Аналитика постов ВКонтакте</p>
      <button onclick="nextStep(1)" class="btn text-2xl">Начать</button>
    </div>
  </div>

  <!-- 1. Токен MWS -->
  <div id="step1" class="screen flex-col items-center justify-center">
    <div class="card">
      <h2 class="text-3xl font-bold mb-8 text-center">Токен MWS Tables</h2>
      <input type="password" id="mws_token" placeholder="uskHkT7B4UJnGIAwxQUwXzu..." class="mb-8">

      <div class="relative mb-8">
        <button id="template-btn" class="btn w-full flex items-center justify-center gap-3">
          Скачать шаблон
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
          </svg>
        </button>
        <div id="template-dropdown" class="dropdown">
          <a href="#" onclick="downloadTemplate('vk'); return false;">Шаблон ВКонтакте</a>
          <a href="#" onclick="downloadTemplate('all'); return false;" class="border-t border-white/10">Универсальный</a>
        </div>
      </div>

      <button onclick="saveToken()" class="btn w-full text-xl">Продолжить</button>
    </div>
  </div>

  <!-- 2. Подключение -->
  <div id="step2" class="screen flex-col items-center justify-center">
    <div class="card w-full max-w-4xl">
      <h2 class="text-3xl font-bold mb-10 text-center">Подключи сообщество</h2>
      <button onclick="addSourceForm()" class="btn w-full mb-8">+ Добавить</button>
      <div id="sources-list" class="space-y-8"></div>
      <button onclick="loadDashboard()" class="btn w-full text-2xl mt-10">Загрузить дашборд</button>
    </div>
  </div>

  <!-- 3. Дашборд — ВЕРТИКАЛЬНО! -->
  <div id="step3" class="screen flex-col items-center p-8 w-full">
    <h1 class="text-6xl font-black text-center mb-16">Аналитика постов</h1>

    <!-- Вертикальные карточки статистики -->
    <div class="stats-grid w-full">
      <div class="stat-block">
        <div id="stat-posts" class="stat-value">0</div>
        <div class="stat-label">Постов</div>
      </div>
      <div class="stat-block">
        <div id="stat-views" class="stat-value">0</div>
        <div class="stat-label">Просмотры</div>
      </div>
      <div class="stat-block">
        <div id="stat-likes" class="stat-value">0</div>
        <div class="stat-label">Лайки</div>
      </div>
      <div class="stat-block">
        <div id="stat-comments" class="stat-value">0</div>
        <div class="stat-label">Комментарии</div>
      </div>
    </div>

    <!-- Графики — тоже вертикально -->
    <div class="mt-20 space-y-12 w-full max-w-2xl mx-auto">
      <div class="bg-white/10 backdrop-blur-lg rounded-3xl p-10">
        <div class="flex justify-between items-center mb-8">
          <h3 class="text-3xl font-bold">Динамика</h3>
          <div class="flex gap-4">
            <select id="metric" class="bg-white/20 px-6 py-3 rounded-xl">
              <option value="likes">Лайки</option>
              <option value="views">Просмотры</option>
            </select>
            <select id="period" class="bg-white/20 px-6 py-3 rounded-xl">
              <option value="week">Неделя</option>
              <option value="month">Месяц</option>
            </select>
          </div>
        </div>
        <canvas id="lineChart" height="300"></canvas>
      </div>

      <div class="bg-white/10 backdrop-blur-lg rounded-3xl p-10">
        <h3 class="text-3xl font-bold text-center mb-8">Структура охвата</h3>
        <canvas id="doughnutChart" height="300"></canvas>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const API = location.origin;
    let lineChart = null, doughnutChart = null;

    function nextStep(n) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById('step' + n).classList.add('active');
    }

    function toast(msg) {
      const t = document.createElement('div');
      t.textContent = msg;
      t.className = 'toast show';
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 3000);
    }

    async function saveToken() {
      const token = document.getElementById('mws_token').value.trim();
      if (!token) return toast('Введи токен!');
      await fetch(`${API}/mws-api`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ "mws-token": token }) });
      nextStep(2);
      addSourceForm();
      toast('Токен сохранён');
    }

    // Дропдаун
    const btn = document.getElementById('template-btn');
    const drop = document.getElementById('template-dropdown');
    btn.addEventListener('mouseenter', () => drop.classList.add('show'));
    btn.addEventListener('mouseleave', () => setTimeout(() => { if (!drop.matches(':hover')) drop.classList.remove('show'); }, 100));
    drop.addEventListener('mouseenter', () => drop.classList.add('show'));
    drop.addEventListener('mouseleave', () => drop.classList.remove('show'));

    async function downloadTemplate(type) {
      try {
        const res = await fetch(`${API}/api/download-template/${type}`);
        if (!res.ok) throw '';
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = type === 'vk' ? 'шаблон_вк.xlsx' : 'шаблон_универсальный.xlsx';
        a.click();
        URL.revokeObjectURL(url);
        toast('Скачано!');
      } catch { toast('Ошибка'); }
    }

    function addSourceForm() {
      const list = document.getElementById('sources-list');
      const div = document.createElement('div');
      div.className = 'bg-white/10 backdrop-blur-lg rounded-3xl p-8 border border-white/20';
      div.innerHTML = `
        <input type="url" placeholder="Ссылка на таблицу MWS" required>
        <input type="text" placeholder="ID группы ВК (mts, 123456789)" required>
        <input type="password" placeholder="Токен группы ВК" required>
        <button type="button" onclick="this.parentElement.remove()" class="text-red-400 text-sm mt-4">Удалить</button>
      `;
      list.appendChild(div);
    }

    async function loadDashboard() {
      const forms = document.querySelectorAll('#sources-list > div');
      let ok = 0;
      for (const f of forms) {
        const [url, groupId, vkToken] = f.querySelectorAll('input');
        if (!url.value.trim() || !groupId.value.trim() || !vkToken.value.trim()) continue;
        const fd = new FormData();
        fd.append("table_name", "vk_group");
        fd.append("platform", "vk");
        fd.append("url", url.value.trim());
        fd.append("token", vkToken.value.trim());
        fd.append("group_id", groupId.value.trim());
        try {
          const r = await fetch(`${API}/api/add-table`, { method: 'POST', body: fd });
          if (r.ok) ok++;
        } catch {}
      }
      if (ok === 0) return toast('Ничего не подключено');
      toast(`Подключено: ${ok}`);
      nextStep(3);
      setTimeout(loadStatsAndCharts, 1000);
    }

    async function loadStatsAndCharts() {
      try {
        const s = await (await fetch(`${API}/api/statistics`)).json();
        document.getElementById('stat-posts').textContent = s.total_posts || 0;
        document.getElementById('stat-views').textContent = Number(s.total_views || 0).toLocaleString();
        document.getElementById('stat-likes').textContent = Number(s.total_likes || 0).toLocaleString();
        document.getElementById('stat-comments').textContent = Number(s.total_comments || 0).toLocaleString();
      } catch {}

      try {
        const m = document.getElementById('metric').value;
        const p = document.getElementById('period').value;
        const line = await (await fetch(`${API}/chart-data?metric=${m}&period=${p}`)).json();
        const pie = await (await fetch(`${API}/chart-reach`)).json();

        if (lineChart) lineChart.destroy();
        if (doughnutChart) doughnutChart.destroy();

        lineChart = new Chart(document.getElementById('lineChart'), {
          type: 'line',
          data: { labels: line.labels, datasets: [{ data: line.values, borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.2)', tension: 0.4, fill: true }] },
          options: { responsive: true, plugins: { legend: { display: false } } }
        });

        doughnutChart = new Chart(document.getElementById('doughnutChart'), {
          type: 'doughnut',
          data: { labels: pie.labels, datasets: [{ data: pie.values, backgroundColor: ['#10b981', '#3b82f6', '#f59e0b'] }] },
          options: { responsive: true }
        });
      } catch {}
    }

    document.getElementById('metric')?.addEventListener('change', loadStatsAndCharts);
    document.getElementById('period')?.addEventListener('change', loadStatsAndCharts);
  </script>
</body>
</html>